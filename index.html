
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Rome Accidents</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI=" crossorigin="" />
    <link href="https://unpkg.com/tabulator-tables@6.2.1/dist/css/tabulator.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />

    <script type="text/javascript" src="https://unpkg.com/tabulator-tables@6.2.1/dist/js/tabulator.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin=""></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script type="text/javascript" src="https://oss.sheetjs.com/sheetjs/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.20/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/jquery/latest/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>


    <style>
        #map { width: 1024px; height: 768px; }
        body { font: 16px/1.4 "Helvetica Neue", Arial, sans-serif; }
        .ghbtns { position: relative; top: 4px; margin-left: 5px; }
        a { color: #0077ff; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Rome Accidents</h1>
        <div class="row">
            <div class="col-md-12 mx-auto p-2" style="width: 1024px;"><div id="map"></div></div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <input type="text" id="daterange" value="" />
                <button onclick='clearDtFilter();' class="btn btn-danger">Clear date filter</button>
                <label for="start-time">Start time: </label>
                <input
                    id="start-time"
                    type="time"
                    name="start-time"
                    min="00:00"
                    max="23:59"
                    pattern="[0-9]{2}:[0-9]{2}"
                    value="00:00"
                />
                <label for="end-time">End time: </label>
                <input
                    id="end-time"
                    type="time"
                    name="end-time"
                    min="00:00"
                    max="23:59"
                    pattern="[0-9]{2}:[0-9]{2}"
                    value="23:59"
                />
                <button onclick='clearTimeFilter();' class="btn btn-danger">Clear time filter</button>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <div>
                    <button id="download-csv" class="btn btn-primary">Download CSV</button>
                    <button id="download-json" class="btn btn-primary">Download JSON</button>
                    <button id="download-xlsx" class="btn btn-primary">Download XLSX</button>
                    <button id="download-pdf" class="btn btn-primary">Download PDF</button>
                    <button id="download-html" class="btn btn-primary">Download HTML</button>
                </div>
                <div id="table"></div>
            </div>
        </div>
    </div>

<p>Built with <a href="https://github.com/Leaflet/Leaflet.heat">LeafLet Heat</a></p>
<script src="leaflet-heat.js"></script>

<script>

    var DateTime = luxon.DateTime;

    var map = L.map('map').setView([41.9018, 12.4921], 12);

    var tiles = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors',
    }).addTo(map);

    var heat = null;

    function weekDayFilter(headerValue, rowValue, rowData, filterParams){
        //headerValue - the value of the header filter element
        //rowValue - the value of the column in this row
        //rowData - the data for the row being filtered
        //filterParams - params object passed to the headerFilterFuncParams property
        if (headerValue.length === 0) {
            return true;
        }
        return headerValue.includes(rowValue);
    }

    var table = new Tabulator("#table", {
        ajaxURL:"data.json",
        maxHeight:750,
        layout:"fitDataFill", //fit columns to width of table (optional)
        resizableColumnFit:true,
        pagination:"local",
        paginationSize:10,
        paginationSizeSelector:[10, 20, 50, 100],
        movableColumns:true,
        paginationCounter:"rows",
        columns: [
            {title: "Protocol", field: "protocol", headerFilter:"input"},
            {title: "DateTime", field: "date_time", formatter:"datetime", formatterParams:{
                inputFormat:"yyyy-MM-dd HH:mm:ss",
                outputFormat:"yyyy-MM-dd HH:mm:ss",
                invalidPlaceholder:"(invalid date)",
                timezone:"Europe/Rome",
            }},
            {title: "Week Day", field: "day_of_week", headerFilterFunc:weekDayFilter, headerFilter:"list", headerFilterParams:{
                values: ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"],
                multiselect:true,
            }},
            {title: "Type of accident", field: "type_of_accident", headerFilter:"input"},
            {title: "Longitude", field: "longitude", headerFilter:"input"},
            {title: "Latitude", field: "latitude", headerFilter:"input"},
        ],
    });

    function datum2latlon(datum) {
        return {lat: datum["latitude"], lon: datum["longitude"]}
    }

    function datum2dt(datum) {
        return DateTime.fromFormat(datum['date_time'], "yyyy-MM-dd HH:mm:ss");
    }

    var date_range_picker = null;
    var dt_start_filter = null;
    var dt_end_filter = null;
    var min_date_global = null;
    var max_date_global = null;

    function clearDtFilter(){
        if (date_range_picker === null) {
            return;
        }
        dt_start_filter = min_date_global;
        dt_end_filter = max_date_global;
        date_range_picker.data('daterangepicker').setStartDate(dt_start_filter);
        date_range_picker.data('daterangepicker').setEndDate(dt_end_filter);
        table.refreshFilter();
    }

    function filterDt(datum) {
        if (dt_start_filter === null) {
            return true;
        }
        var dt = DateTime.fromFormat(datum['date_time'], "yyyy-MM-dd HH:mm:ss");
        if (dt < dt_start_filter) {
            return false;
        }
        if (dt > dt_end_filter) {
            return false;
        }
        return true;
    }

    var time_start_filter = "00:00";
    var time_end_filter = "23:59";

    const start_time_picker = $("#start-time");
    const end_time_picker = $("#end-time");

    function filterTime(datum) {
        var dt = DateTime.fromFormat(datum['date_time'], "yyyy-MM-dd HH:mm:ss").toLocaleString(DateTime.TIME_24_SIMPLE);
        if (dt < time_start_filter) {
            return false;
        }
        if (dt > time_end_filter) {
            return false;
        }
        return true;
    }

    function clearTimeFilter(){
        time_start_filter = "00:00";
        time_end_filter = "23:59";
        start_time_picker.val("00:00");
        end_time_picker.val("23:59");
        table.refreshFilter();
    }

    table.on('tableBuilt', function(){

        heat = L.heatLayer(
            table.getData("active").map(datum2latlon), {radius: 10},
        ).addTo(map);

        table.on("dataFiltered", function(filters, rows){
            heat.setLatLngs(rows.map(ele => ele.getData()).map(datum2latlon));
            heat.redraw();
        });

        min_date_global = DateTime.min(...table.getData("active").map(datum2dt));
        max_date_global = DateTime.max(...table.getData("active").map(datum2dt));
        dt_start_filter = min_date_global;
        dt_end_filter = max_date_global;

        table.setFilter(filterDt);

        date_range_picker = $("#daterange").daterangepicker({
            opens: 'left',
            startDate: min_date_global,
            endDate: max_date_global,
        }, function(start, end, label) {
            dt_start_filter = start;
            dt_end_filter = end;
            table.refreshFilter();
        });

        table.setFilter(filterTime);

        start_time_picker.on("change", function() {
            time_start_filter = start_time_picker.val();
            table.refreshFilter();
        })

        end_time_picker.on("change", function() {
            time_end_filter = end_time_picker.val();
            table.refreshFilter();
        })

    });

    //trigger download of data.csv file
    document.getElementById("download-csv").addEventListener("click", function(){
        table.download("csv", "data.csv");
    });

    //trigger download of data.json file
    document.getElementById("download-json").addEventListener("click", function(){
        table.download("json", "data.json");
    });

    //trigger download of data.xlsx file
    document.getElementById("download-xlsx").addEventListener("click", function(){
        table.download("xlsx", "data.xlsx", {sheetName:"My Data"});
    });

    //trigger download of data.pdf file
    document.getElementById("download-pdf").addEventListener("click", function(){
        table.download("pdf", "data.pdf", {
            orientation:"portrait", //set page orientation to portrait
            title:"Example Report", //add title to report
        });
    });

    //trigger download of data.html file
    document.getElementById("download-html").addEventListener("click", function(){
        table.download("html", "data.html", {style:true});
    });

</script>
</body>
</html>
